//---------------------------------------------------------------------------
#include <vcl.h>
#include <windows.h>
#include <string>
#pragma hdrstop

#include "DataModule1.h"
#include <System.DateUtils.hpp>
#include <System.SysUtils.hpp>
#include <System.IOUtils.hpp>
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma classgroup "Vcl.Controls.TControl"
#pragma resource "*.dfm"
TDM *DM;
//---------------------------------------------------------------------------
__fastcall TDM::TDM(TComponent* Owner)
	: TDataModule(Owner)
{
}

//---------------------------------------------------------------------------
// Получение пути к конфигурационному файлу
String __fastcall TDM::GetConfigFilePath()
{
	String exePath = ExtractFilePath(ParamStr(0));
	String configPath = exePath + "db_config.ini";

	// Проверяемм существование файла
	if (!FileExists(configPath)) {
		TIniFile *ini = new TIniFile(configPath);
		try
		{
			ini->WriteString("Database", "Host", "students.ami.nstu.ru");
			ini->WriteString("Database", "Port", "5432");
			ini->WriteString("Database", "Database", "students");
			ini->WriteString("Database", "User", "pmi-b2702");
			ini->WriteString("Database", "Password", "4ioi#ZHzE");
			ini->WriteString("Database", "Schema", "pmib2702");
			ini->WriteString("Database", "Driver", "PostgreSQL Unicode");
			ini->WriteString("Database", "Postgre_DSN", "PostgreSQL35W");

			ShowMessage("Configuration file created:\n" + configPath + "\n\nPlease check the settings and restart the application.");
		}
		__finally
		{
			delete ini;
        }
	}
    return configPath;
}

//---------------------------------------------------------------------------
// Загрузка конфигурации из INI файла
bool __fastcall TDM::LoadDatabaseConfig()
{
    try
    {
        String configPath = GetConfigFilePath();

		if (!FileExists(configPath))
		{
            throw Exception("Configuration file not found: " + configPath);
        }

        TIniFile *ini = new TIniFile(configPath);
        try
        {
            FDBConfig.Host = ini->ReadString("Database", "Host", "localhost");
            FDBConfig.Port = ini->ReadString("Database", "Port", "5432");
            FDBConfig.Database = ini->ReadString("Database", "Database", "postgres");
            FDBConfig.User = ini->ReadString("Database", "User", "postgres");
            FDBConfig.Password = ini->ReadString("Database", "Password", "");
			FDBConfig.Schema = ini->ReadString("Database", "Schema", "public");
			FDBConfig.Driver = ini->ReadString("Database", "Driver", "PostgreSQL Unicode");
			FDBConfig.Postgre_DSN = ini->ReadString("Database", "Postgre_DSN", "PostgreSQL35W");

            FSchemaName = FDBConfig.Schema;

            // Проверка обязательных параметров
            if (FDBConfig.Host.IsEmpty() || FDBConfig.User.IsEmpty())
            {
                throw Exception("Configuration file contains empty required fields!");
            }

            return true;
        }
        __finally
        {
            delete ini;
        }
    }
    catch (Exception &e)
    {
        ShowMessage("Error loading configuration:\n" + e.Message);
        return false;
    }
}

//---------------------------------------------------------------------------
// Создание модуля данных
void __fastcall TDM::DataModuleCreate(TObject *Sender)
{
    try
	{
        if (!LoadDatabaseConfig())
        {
            throw Exception("Failed to load database configuration!");
        }
        Sleep(50);
		ConnectToDatabase();
        CheckDatabaseStructure();
        LoadDetailsQuery();

        // Настраиваем событие AfterScroll для автоматического обновления второго грида
        if (QueryDetails)
            QueryDetails->AfterScroll = QueryDetailsAfterScroll;
    }
    catch (Exception &e)
    {
        ShowMessage("Error while initialising the data module: " + e.Message);
    }
}
//---------------------------------------------------------------------------

//---------------------------------------------------------------------------
// Метод для проверки существования таблиц
void __fastcall TDM::CheckDatabaseStructure()
{
    TADOQuery *CheckQuery = new TADOQuery(this);
    try
    {
        CheckQuery->Connection = ADOConnection1;

        // Проверяем существование таблиц
        CheckQuery->SQL->Clear();
        CheckQuery->SQL->Add(
            "SELECT table_name FROM information_schema.tables "
			"WHERE table_schema = 'pmib2702' AND table_name IN ('p', 'j', 'q', 'r', 's', 'c', 'v', 'w', 'e', 'spj', 'spj1')"
		);
        CheckQuery->Open();

        String tables = "";
        while (!CheckQuery->Eof)
        {
            tables = tables + CheckQuery->FieldByName("table_name")->AsString + ", ";
            CheckQuery->Next();
        }

        ShowMessage("Найдены таблицы: " + tables);
        CheckQuery->Close();
        delete CheckQuery;
    }
    catch (Exception &e)
    {
        delete CheckQuery;
        ShowMessage("Ошибка проверки структуры БД: " + e.Message);
    }
}
//---------------------------------------------------------------------------

void __fastcall TDM::ConnectToDatabase()
{
    try
    {
        if (!ADOConnection1)
            return;

		ADOConnection1->Close();

		// Format 1
		ADOConnection1->ConnectionString =
		"Provider=MSDASQL.1;"
		"DSN=" + FDBConfig.Postgre_DSN + ";"
		"Server=" + FDBConfig.Host + ";"
		"Port=" + FDBConfig.Port + ";"
		"Database=" + FDBConfig.Database + ";"
		"Uid=" + FDBConfig.User + ";"
		"Pwd=" + FDBConfig.Password + ";"
		"SSLmode=prefer;";

		// Format 2
		ADOConnection1->ConnectionString =
			"Provider=MSDASQL.1;"
			"Driver=" + FDBConfig.Driver + ";"
			"Server=" + FDBConfig.Host + ";"
			"Port=" + FDBConfig.Port + ";"
			"Database=" + FDBConfig.Database + ";"
			"Uid=" + FDBConfig.User + ";"
			"Pwd=" + FDBConfig.Password + ";"
			"SSLmode=prefer;";

        ADOConnection1->LoginPrompt = false;
		ADOConnection1->Open();

        String message =
            String().sprintf(
                L"Соединение с базой данных установлено успешно!\n"
                L"Server: %s\n"
                L"Database: %s\n"
                L"Schema: %s",
                FDBConfig.Host.c_str(),
                FDBConfig.Database.c_str(),
				FSchemaName.c_str()
            );

        ShowMessage(message);
	}
    catch (Exception &e)
    {
        throw Exception("Ошибка подключения к БД: " + e.Message +
                       "\nПроверьте:\n"
                       "1. Наличие ODBC источника данных 'PostgreSQL_DSN'\n"
                       "2. Корректность логина/пароля\n"
                       "3. Доступность сервера БД");
    }
}
//---------------------------------------------------------------------------

// ЗАПРОС 1: Загрузка данных о деталях и изделиях
void __fastcall TDM::LoadDetailsQuery()
{
	try
	{
		QueryDetails->Close();

		// SQL-запрос для получения информации о деталях и изделиях
		QueryDetails->SQL->Clear();
		QueryDetails->SQL->Add(
		"SELECT"
		"	p.n_det,"
		"	p.name AS det_name,"
		"	j.n_izd,"
		"	j.name AS izd_name, "
		"	COALESCE(nalichie.kol_nalichie, 0) AS kol_nalichie, "
		"	COALESCE(potrebnost.kol_trebuetsya, 0) AS kol_trebuetsya, "
		"	CASE "
		"		WHEN COALESCE(nalichie.kol_nalichie, 0) < COALESCE(potrebnost.kol_trebuetsya, 0) "
		"		THEN 'ДЕФИЦИТ' "
		"		ELSE 'OK' "
		"	END AS status "
		"FROM " + FSchemaName + ".p p "
		"CROSS JOIN " + FSchemaName + ".j j "
		"INNER JOIN " + FSchemaName + ".q q ON p.n_det = q.n_det AND j.n_izd = q.n_izd "
		"LEFT JOIN ( "
		"	SELECT "
		"		n_det, "
		"		n_izd, "
		"		SUM(kol) AS kol_nalichie "
		"	FROM " + FSchemaName + ".spj1 spj1 "
		"	GROUP BY n_det, n_izd "
		") AS nalichie ON p.n_det = nalichie.n_det AND j.n_izd = nalichie.n_izd "
		"LEFT JOIN ( "
		"	SELECT "
		"		q.n_det, "
		"		q.n_izd, "
		"		SUM(r.kol * q.kol) AS kol_trebuetsya "
		"	FROM " + FSchemaName + ".r r"
		"	INNER JOIN " + FSchemaName + ".q q ON r.n_izd = q.n_izd "
		"	WHERE r.date_ship IS NULL "
		"	GROUP BY q.n_det, q.n_izd "
		") AS potrebnost ON p.n_det = potrebnost.n_det AND j.n_izd = potrebnost.n_izd "
		"ORDER BY p.n_det, j.n_izd ASC;"
		);

        QueryDetails->Open();
    }
    catch (Exception &e)
    {
        throw Exception("Ошибка выполнения запроса 1: " + e.Message);
    }
}
//---------------------------------------------------------------------------

// ЗАПРОС 2: Загрузка заказов для указанной детали
void __fastcall TDM::LoadOrdersForDetail(String detailNum)
{
    try
    {
        QueryOrders->Close();

        QueryOrders->SQL->Clear();
		QueryOrders->SQL->Add(
            "SELECT "
            "    r.n_real AS n_zakaza, "
            "    r.date_order AS data_zakaza, "
            "    c.name AS zakazchik, "
			"    j.name AS izdelie, "
            "    r.kol AS kol_izdeliy, "
            "    q.kol AS kol_det_na_1_izd, "
			"    (r.kol * q.kol) AS kol_det_trebuetsya, "
			"    COALESCE(nalichie.kol_det_nalichie, 0) AS kol_det_nalichie, "
			"    CASE"
			"	     WHEN COALESCE(nalichie.kol_det_nalichie, 0) < (r.kol * q.kol) "
			"        THEN 'ДЕФИЦИТ' "
			"        ELSE 'OK' "
			"    END AS status "
			"FROM " + FSchemaName + ".r r "
			"INNER JOIN " + FSchemaName + ".c c ON r.n_cl = c.n_cl "
			"INNER JOIN " + FSchemaName + ".j j ON r.n_izd = j.n_izd "
			"INNER JOIN " + FSchemaName + ".q ON r.n_izd = q.n_izd "
			"LEFT JOIN ( "
			"     SELECT n_det, "
			"            n_izd, "
			"            SUM(kol) AS kol_det_nalichie "
			"     FROM " + FSchemaName + ".spj1"
			"     GROUP BY n_det, n_izd "
			") AS nalichie ON q.n_det = nalichie.n_det AND r.n_izd = nalichie.n_izd "
            "WHERE q.n_det = :n_det "
            "AND r.date_ship IS NULL "
			"ORDER BY r.date_order ASC; "
        );

		QueryOrders->Parameters->ParamByName("n_det")->Value = detailNum;
        QueryOrders->Open();
    }
    catch (Exception &e)
    {
		throw Exception("Ошибка выполнения запроса 2: " + e.Message);
    }
}
//---------------------------------------------------------------------------

// Обработчик события прокрутки в первом запросе
void __fastcall TDM::QueryDetailsAfterScroll(TDataSet *DataSet)
{
    try
    {
        if (!QueryDetails->IsEmpty())
        {
            String detailNum = QueryDetails->FieldByName("n_det")->AsString.Trim();
            LoadOrdersForDetail(detailNum);
        }
    }
    catch (Exception &e)
    {
        ShowMessage("Ошибка при обновлении списка заказов: " + e.Message);
    }
}
//---------------------------------------------------------------------------

// ЗАПРОС 3: Добавление нового заказа
bool __fastcall TDM::AddNewOrder(String nIzd, String nCl, int kol, double cost, Variant datePay, Variant dateShip)
{
	TADOQuery *InsertQuery = new TADOQuery(this);
    try
    {
		InsertQuery->Connection = ADOConnection1;

        // Генерация нового номера заказа
        TADOQuery *MaxQuery = new TADOQuery(this);
        try
        {
            MaxQuery->Connection = ADOConnection1;
            MaxQuery->SQL->Add(
                "SELECT COALESCE(MAX(CAST(SUBSTRING(n_real FROM 2) AS INTEGER)), 0) + 1 AS next_num "
				"FROM " + FSchemaName + ".r WHERE n_real ~ '^R[0-9]+$'"
			);
            MaxQuery->Open();
            int nextNum = MaxQuery->FieldByName("next_num")->AsInteger;
            String newOrderNum = "R" + IntToStr(nextNum);
            MaxQuery->Close();
            delete MaxQuery;

            // Вставка нового заказа
            InsertQuery->SQL->Clear();
            InsertQuery->SQL->Add(
				"INSERT INTO " + FSchemaName + ".r (n_real, n_izd, n_cl, date_order, kol, cost, date_pay, date_ship) "
				"VALUES (:n_real, :n_izd, :n_cl, :date_order, :kol, :cost, :date_pay, :date_ship)"
            );

            InsertQuery->Parameters->ParamByName("n_real")->Value = newOrderNum;
            InsertQuery->Parameters->ParamByName("n_izd")->Value = nIzd;
            InsertQuery->Parameters->ParamByName("n_cl")->Value = nCl;
            InsertQuery->Parameters->ParamByName("date_order")->Value = Date();
            InsertQuery->Parameters->ParamByName("kol")->Value = kol;
			InsertQuery->Parameters->ParamByName("cost")->Value = cost;

			if (datePay.IsNull()) {
				 InsertQuery->Parameters->ParamByName("date_pay")->Value = Null;
			}  else {
				 InsertQuery->Parameters->ParamByName("date_pay")->Value = datePay;
			}

			if (dateShip.IsNull()) {
				 InsertQuery->Parameters->ParamByName("date_ship")->Value = Null;
			}  else {
				 InsertQuery->Parameters->ParamByName("date_ship")->Value = dateShip;
			}

			InsertQuery->ExecSQL();

			String message = "Заказ " + newOrderNum + " успешно добавлен!\n" +
                       "Изделие: " + nIzd + "\n" +
                       "Заказчик: " + nCl + "\n" +
					   "Количество: " + IntToStr(kol) + "\n" +
					   "Цена: " + FloatToStrF(cost, ffFixed, 10, 2) + "\n" +
					   "Payment date: " + (datePay.IsNull() ? "Not specified (NULL)" : DateToStr(datePay)) + "\n" +
					   "Shipping date: " + (dateShip.IsNull() ? "Not specified (NULL)" : DateToStr(dateShip));

			ShowMessage(message);

			// Обновляем данные в запросах
            LoadDetailsQuery();

            delete InsertQuery;
            return true;
        }
        catch (...)
        {
            delete MaxQuery;
            throw;
        }
    }
    catch (Exception &e)
    {
        delete InsertQuery;
        ShowMessage("Ошибка при добавлении заказа: " + e.Message);
        return false;
    }
}
//---------------------------------------------------------------------------

// Получить количество деталей в наличии
int __fastcall TDM::GetAvailableDetails(String nDet, String nIzd)
{
    TADOQuery *Query = new TADOQuery(this);
    try
    {
        Query->Connection = ADOConnection1;
        Query->SQL->Add(
            "SELECT COALESCE(SUM(kol), 0) AS total "
			"FROM " + FSchemaName + ".spj1 "
            "WHERE n_det = :n_det AND n_izd = :n_izd"
        );
        Query->Parameters->ParamByName("n_det")->Value = nDet;
        Query->Parameters->ParamByName("n_izd")->Value = nIzd;
        Query->Open();

        int result = Query->FieldByName("total")->AsInteger;
        Query->Close();
        delete Query;
        return result;
    }
    catch (Exception &e)
    {
        delete Query;
        return 0;
    }
}
//---------------------------------------------------------------------------